name: 2Actions-exporter job

on:
  workflow_dispatch:
    
jobs:
  build:
    name: Run github-actions-exporter
    runs-on: self-hosted
    container:
      image: spendeskplatform/github-actions-exporter:v1.8.1
      
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.event.repository.full_name }}
        GITHUB_WORKFLOW: ${{ github.event.workflow.name }}
        METRICS_PATH: "/metrics"
      ports:
        - 9999:9999
      
    steps:
      - name: Wait for the server to start
        run: sleep 5
      
      - name: Check the metrics endpoint
        run: curl -s localhost:9999/metrics

      # - name: Build GitHub Actions Exporter Docker image
      #   run: |
      #     cd github-actions-exporter
      #     docker build -t spendeskplatform/github-actions-exporter:latest .
      
      
      # #TODO: Delete prevous containers to avoid name duplication
      # - name: Run GitHub Actions Exporter
      #   run: |
      #     docker run -d \
      #       --name github-actions-exporter-unique-27 \
      #       -p 9999:9999 \
      #       -e GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
      #       -e GITHUB_REPOSITORY=${{ github.event.repository.full_name }} \
      #       spendeskplatform/github-actions-exporter:v1.8.1
    
      # - name: Pointless echo
      #   run: |
      #     echo ${{ github.event.repository.full_name }}
      
      # - name: Expose workflow run status
      #   run: |
      #       echo "github_workflow_run_status $(echo ${{ job.status }} | tr '[:upper:]' '[:lower:]') $(date +%s)" | \
      #         docker run --rm -i --network=host --entrypoint=/bin/sh -e "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" \
      #         spendeskplatform/github-actions-exporter:latest -c 'echo "$0" | curl --data-binary @- http://localhost:9999/metrics/job/github_workflow_run_status/instance/$GITHUB_REPOSITORY' 


#-e GITHUB_REPOSITORY=${{ github.repository }} \
            
